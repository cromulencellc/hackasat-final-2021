<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Hack-a-Sat 2 Dashboard</title>
    <meta name="description" content="Hack-a-Sat 2 Dashboard" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" media="all" href="../assets/application.css" />
    <script src="../assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

    <style>
        .container {
            width: 100%;
            padding-right: var(--bs-gutter-x, .25rem);
            padding-left: var(--bs-gutter-x, .25rem);
            margin-right: 0;
            margin-left: 0;
        }
        
        .row {
            /*
            min-width: 0;
            min-height: 0;
            overflow: visible;
            flex-wrap: nowrap;
            flex: 1;
            */
        }
        
        .col {
            /*
            flex: 1;
            display: flex;
            */
        }
        
        .frame {
            flex: 1 1 auto;
            border: 0;
            width: max-content;
        }
        
        .header.nav-down {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            right: 0;
            top: 0;
            /*width: 100%;*/
        }
        
        .header--transparent {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            /* width : 100%;*/
        }
        
        .footer.nav-down {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            right: 0;
            top: 0;
            /*width: 100%;*/
        }
        
        .footer--transparent {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            /* width : 100%;*/
        }
    </style>

</head>

<body>
    <header class="header header--transparent nav-down">
        <div class="container-fluid header-content">
            <h2>Hack-a-Sat 2 Dashboard</h2>
        </div>
    </header>



    <!-- Bootstrap core CSS -->
    <div class="container">
        <div class="row">
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team1"> </iframe>
            </div>
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team2"> </iframe>
            </div>
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team3"> </iframe>
            </div>
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team4"> </iframe>
            </div>
            <!-- Put another row here to force 4 across -->
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team5"> </iframe>
            </div>
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team6"> </iframe>
            </div>
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team7"> </iframe>
            </div>
            <div class="col">
                <iframe class="frame" src="frame.content.html" id="team8"> </iframe>
            </div>
        </div>
        <!-- end 2nd row-->
    </div>
    <!-- end container-->



    <footer>
        <div>
            <div>
                <script>
                    function makeTimer() {

                        var endTime = new Date("Dec 12, 2021 14:00:00 UTC-04:00");
                        var endTime = (Date.parse(endTime)) / 1000;

                        var now = new Date();
                        var now = (Date.parse(now) / 1000);

                        var timeLeft = endTime - now;

                        var days = Math.floor(timeLeft / 86400);
                        var hours = Math.floor((timeLeft - (days * 86400)) / 3600);
                        var minutes = Math.floor((timeLeft - (days * 86400) - (hours * 3600)) / 60);
                        var seconds = Math.floor((timeLeft - (days * 86400) - (hours * 3600) - (minutes * 60)));

                        if (hours < "10") {
                            hours = "0" + hours;
                        }
                        if (minutes < "10") {
                            minutes = "0" + minutes;
                        }
                        if (seconds < "10") {
                            seconds = "0" + seconds;
                        }

                        if (timeLeft < 0) {
                            days = 0;
                            hours = 0;
                            minutes = 0;
                            seconds = 0;
                        }

                        $("#days").html(days + "<span>Days</span>");
                        $("#hours").html(hours + "<span>Hours</span>");
                        $("#minutes").html(minutes + "<span>Minutes</span>");
                        $("#seconds").html(seconds + "<span>Seconds</span>");

                    }

                    setInterval(function() {
                        makeTimer();
                    }, 1000);
                </script>

                <style>
                    /* Countdown Timer styling */
                    
                    #timer {
                        text-align: center;
                        clear: both;
                        float: left;
                        white-space: nowrap;
                    }
                    
                    #timer>div {
                        display: inline-block;
                        text-align: center;
                        margin: 0 10px;
                        font-weight: 900;
                    }
                    
                    #timer>div>span {
                        display: block;
                        font-size: 12px;
                        font-weight: 300;
                    }
                </style>


                <div id="timer">
                    <div><span>Game Time Remaining</span></div>
                    <div id="days">52<span>Days</span></div>
                    <div id="hours">19<span>Hours</span></div>
                    <div id="minutes">17<span>Minutes</span></div>
                    <div id="seconds">45<span>Seconds</span></div>
                </div>

            </div>
        </div>
    </footer>

    <script type="text/javascript" src="../assets/js/iframeResizer.js"></script>

    <script type="text/javascript">
        iFrameResize({
            log: false,
            heightCalculationMethod: 'lowestElement'
        })
    </script>

    <script>
        var allFramesLoaded = false;
        window.setInterval(function() {
            /// call your function here
            getHasScoresJsonOnly();
        }, 6000); // Change Interval here to test. For eg: 5000 for 5 sec
    </script>



    <script id="get-has-scores-json-only">
        var newjsonOnlyResponseObj;
        var oldjsonOnlyResponseObj;

        async function getHasScoresJsonOnly() {
            //TODO change this to the URL for the scoring server
            //Just get the json, don't do anything else.  We set an observer 
            //on the json object and kickoff the full parser when it changes.
            var res = await fetch('./newscoreboard.json', {
           //var res = await fetch('https://finals.2021.hackasat.com/scoreboard.json', {
                headers: {
                    Accept: 'application/json',
                    Pragma: 'no-cache',
                    ContentType: 'application/json',
                },
                cache: "no-store",
            });

            const newjsonOnlyResponseObj = await res.json();

            let isEqual = JSON.stringify(newjsonOnlyResponseObj) == JSON.stringify(oldjsonOnlyResponseObj);
            oldjsonOnlyResponseObj = newjsonOnlyResponseObj;
            if (!isEqual) {
                if (allFramesLoaded)
                    getHasScores(newjsonOnlyResponseObj);
            }

        }
    </script>
    <script>
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms))
        }
    </script>

    <script>
        //delay(3000);
        //window.onload = getHasScoresJsonOnly();
    </script>


    <script id="get-has-scores">
        function getHasScores(json) {

            Object.entries(json).forEach(([key, value]) => {
                if (key == 'standings') {
                    //console.log(`${value}.name`);
                    value.forEach(getScore);

                    function getScore(value, index, array) {
                        console.log(value.name + ' ' + value.score);
                        var team_id = index + 1;
                        var doc_id = document.getElementById("team" + team_id);
                        doc_id.name = value.name;
                        teamScoreHtml = doc_id.contentDocument.getElementById("score");

                        if (null != value.score)
                            teamScoreHtml.innerHTML = 'Score: ' + value.score;

                        test = doc_id.contentDocument.getElementById("score").innerHTML;


                        console.log(value.name + ' ' + value.rank);
                        var team_id = index + 1;
                        var doc_id = document.getElementById("team" + team_id);
                        doc_id.name = value.name;
                        doc_id.contentDocument.getElementById("rank").innerHTML = 'Rank: ' + value.rank;
                        test = doc_id.contentDocument.getElementById("rank").innerHTML;

                        //Update the histogram
                        const score_hist_entries = Object.entries(value.scorehistory);
                        const chart = doc_id.contentWindow.myInternalChart;
                        const values = Object.values(score_hist_entries);

                        chart.config.options.scales.xAxes[0].scaleLabel.display = true;
                        chart.config.options.scales.xAxes[0].scaleLabel.labelString = "Game 1/2 Hour"

                        var endTime = new Date("Dec 12, 2021 14:00:00 UTC-04:00");
                        var endTime = (Date.parse(endTime)) / 1000;
                        var now = new Date();
                        var now = (Date.parse(now) / 1000);
                        var timeLeft = endTime - now;
                        var days = Math.floor(timeLeft / 86400);
                        var hours = Math.floor((timeLeft - (days * 86400)) / 3600); //hours left
                        var hours_transpired = 24 - hours;
                        var half_hours_transpired = hours_transpired * 2;

                        //only show data for actual game time.

                        newScoreList = values.sort((a, b) => b[1] - a[1]);
                        //console.log(newScoreList.reverse());
                        newScoreList.reverse();

                        //uncomment to show whole game
                        for (var i = 0; i < values.length; i++) {
                            //for (var i = 0; i < half_hours_transpired; i++) {
                            //chart.config.data.labels[i] = values[i][0]; //TODO change to Hour 1
                            chart.config.data.labels[i] = i;
                            chart.config.data.datasets[0].data[i] = values[i][1];
                        }

                        //colorize the chart line
                        switch (String(value.name)) {
                            case "Poland Can Into Space":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#31BE7E";
                                    chart.config.data.datasets[0].borderColor = "#31BE7E";
                                    chart.config.data.datasets[0].pointBorderColor = "#31BE7E";
                                }
                                break;

                            case "PPP":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#E92389";
                                    chart.config.data.datasets[0].borderColor = "#E92389";
                                    chart.config.data.datasets[0].pointBorderColor = "#E92389";
                                }
                                break;


                            case "FluxRepeatRocket":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#FEEC2B";
                                    chart.config.data.datasets[0].borderColor = "#FEEC2B";
                                    chart.config.data.datasets[0].pointBorderColor = "#FEEC2B";
                                }
                                break;


                            case "DiceGang":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#F72B00";
                                    chart.config.data.datasets[0].borderColor = "#F72B00";
                                    chart.config.data.datasets[0].pointBorderColor = "#F72B00";
                                }
                                break;

                            case "Solar Wine":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#9D91E4";
                                    chart.config.data.datasets[0].borderColor = "#9D91E4";
                                    chart.config.data.datasets[0].pointBorderColor = "#9D91E4";
                                }
                                break;

                            case "SingleEventUpset":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#FF9405";
                                    chart.config.data.datasets[0].borderColor = "#FF9405";
                                    chart.config.data.datasets[0].pointBorderColor = "#FF9405";
                                }
                                break;

                            case "WeltALLES!":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#00EAFF";
                                    chart.config.data.datasets[0].borderColor = "#00EAFF";
                                    chart.config.data.datasets[0].pointBorderColor = "#00EAFF";
                                }
                                break;

                            case "PFS":
                                {
                                    chart.config.data.datasets[0].pointBackgroundColor = "#9F9790";
                                    chart.config.data.datasets[0].borderColor = "#9F9790";
                                    chart.config.data.datasets[0].pointBorderColor = "#9F9790";
                                }
                                break;
                        }

                        chart.update();

                        //Colorize the satellite components according to metrics
                        const metrics_entries = Object.entries(value.metrics);
                        metrics_entries.forEach(([key, value]) => {
                            console.log(`${key}: ${value}`);
                            doc_id.contentWindow.updateDamage(key, value);

                        })

                        doc_id.contentWindow.rotateSatellitePart("Solar_Panels");
                        doc_id.contentWindow.startAnimation("Solar_Panels", "animateTransform");
                    }

                    value.forEach(getTeamName)

                    function getTeamName(value, index, array) {
                        console.log(value.name + ' ' + value.score);
                        var team_id = index + 1;
                        var doc_id = document.getElementById("team" + team_id);
                        doc_id.name = value.name;
                        //doc_id.contentDocument.getElementById("team_name").innerHTML = 'Team: ' + value.name;
                        doc_id.contentDocument.getElementById("team_name").innerHTML = value.name;


                        var image = doc_id.contentDocument.getElementById("team_svg");

                        var hasNodes = image.hasChildNodes();

                        if (hasNodes) {
                            //doc_id.contentDocument.getElementById("team_svg").removeChild(image);
                            image.removeChild(image.childNodes[0]);
                        }
                        var image = new Image();
                        image.src = './teamsvgs/' + value.name + '.svg'
                        image.width = "75";
                        image.height = "75";
                        doc_id.contentDocument.getElementById("team_svg").appendChild(image);
                    }
                }

            });
        }
    </script>

    <script>
        var count = $('iframe').length;
        $(function() {
            // alert('loaded'); // will show you when the regular body loads
            allFramesLoaded = false;
            $('iframe').load(function() {
                while (count > 0) {
                    //delay(1000);
                    console.log(count);
                    count--;
                }
                //alert('all frames loaded');
                allFramesLoaded = true;
            });
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha384-zNy6FEbO50N+Cg5wap8IKA4M/ZnLJgzc6w2NqACZaK0u0FXfOWRRJOnQtpZun8ha" crossorigin="anonymous"></script>




</body>

</html>
